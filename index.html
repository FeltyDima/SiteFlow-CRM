<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SiteFlow CRM — Kanban</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --border-radius: 8px;
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.55;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            padding: 1rem 1.25rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: .6rem
        }

        .logo i {
            color: var(--accent);
            font-size: 1.4rem
        }

        .logo h1 {
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: .2px
        }

        .search-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: .5rem;
            max-width: 560px;
            margin-left: auto
        }

        .search-container i {
            color: var(--text-secondary)
        }

        .search-container input {
            flex: 1;
            padding: .6rem .9rem .6rem 2.2rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--bg-tertiary);
            background: var(--bg-primary);
            color: var(--text-primary);
            outline: none;
        }

        .search-container {
            position: relative
        }

        .search-container>i {
            position: absolute;
            left: .6rem
        }

        /* Layout */
        .main-content {
            display: flex;
            flex: 1;
            min-height: 0
        }

        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            flex-shrink: 0;
            border-right: 1px solid var(--bg-tertiary)
        }

        .nav-section h2 {
            font-size: .78rem;
            text-transform: uppercase;
            letter-spacing: .06em;
            color: var(--text-secondary);
            margin: 0 0 .5rem .25rem
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: .6rem;
            padding: .55rem .6rem;
            border-radius: var(--border-radius);
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer
        }

        .nav-item:hover {
            background: var(--bg-tertiary)
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--accent)
        }

        .nav-item i {
            width: 1.1rem;
            text-align: center
        }

        .content {
            flex: 1;
            padding: 1rem;
            overflow: auto;
            min-width: 0
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem
        }

        .btn {
            padding: .5rem 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--bg-tertiary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: .5rem
        }

        .btn:hover {
            background: #243046
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff
        }

        .btn-primary:hover {
            background: var(--accent-hover)
        }

        /* Kanban */
        .kanban-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: .5rem
        }

        .kanban-column {
            flex: 0 0 300px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: .8rem;
            display: flex;
            flex-direction: column;
            max-height: 72vh;
            border: 1px solid var(--bg-tertiary)
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: .5rem;
            border-bottom: 1px solid var(--bg-tertiary)
        }

        .column-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: .4rem
        }

        .task-count {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: .75rem;
            padding: .1rem .45rem;
            border-radius: 10px
        }

        .task-list {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: .7rem;
            padding-top: .7rem
        }

        .task-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: .75rem;
            cursor: grab;
            border: 1px solid var(--bg-tertiary)
        }

        .task-card:active {
            cursor: grabbing
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: .35rem
        }

        .task-title {
            font-weight: 600;
            margin-bottom: .1rem
        }

        .task-client {
            color: var(--text-secondary);
            font-size: .86rem;
            display: flex;
            gap: .35rem;
            align-items: center
        }

        .task-tags {
            display: flex;
            gap: .35rem;
            margin: .45rem 0 0
        }

        .tag {
            padding: .15rem .45rem;
            border-radius: 4px;
            font-size: .74rem;
            font-weight: 600;
            border: 1px solid transparent
        }

        .tag-urgent {
            background: rgba(239, 68, 68, .12);
            color: var(--danger);
            border-color: rgba(239, 68, 68, .25)
        }

        .tag-waiting {
            background: rgba(234, 179, 8, .12);
            color: var(--warning);
            border-color: rgba(234, 179, 8, .25)
        }

        .tag-paid {
            background: rgba(34, 197, 94, .12);
            color: var(--success);
            border-color: rgba(34, 197, 94, .25)
        }

        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: .55rem;
            padding-top: .45rem;
            border-top: 1px solid var(--bg-tertiary)
        }

        .task-date {
            font-size: .8rem;
            color: var(--text-secondary);
            display: flex;
            gap: .35rem;
            align-items: center
        }

        .task-actions {
            display: flex;
            gap: .4rem
        }

        .task-actions button {
            background: none;
            border: 1px solid var(--bg-tertiary);
            color: var(--text-secondary);
            padding: .3rem .45rem;
            border-radius: 6px;
            cursor: pointer
        }

        .task-actions button:hover {
            color: var(--text-primary);
            border-color: #3b4a65
        }

        /* Drag & drop visuals */
        .task-card.dragging {
            opacity: .6
        }

        .kanban-column.drop-zone {
            outline: 2px dashed var(--accent);
            outline-offset: -6px
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--bg-tertiary);
            border-radius: var(--border-radius);
            width: min(640px, 100%);
            max-height: 90vh;
            overflow: auto;
            padding: 1rem
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: .6rem;
            border-bottom: 1px solid var(--bg-tertiary)
        }

        .modal-header h3 {
            font-weight: 600
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer
        }

        .close-modal:hover {
            color: #fff
        }

        .form-group {
            margin: .9rem 0
        }

        .form-group label {
            display: block;
            margin-bottom: .35rem;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: .9rem
        }

        .form-control {
            width: 100%;
            padding: .6rem .7rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--bg-tertiary);
            background: var(--bg-primary);
            color: #fff;
            outline: none
        }

        .form-control:focus {
            border-color: var(--accent)
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: .6rem;
            margin-top: 1rem
        }

        /* Empty */
        .empty-state {
            text-align: center;
            padding: 1.2rem;
            color: var(--text-secondary)
        }

        .empty-state i {
            font-size: 2rem;
            margin-bottom: .4rem;
            opacity: .6
        }

        /* Responsive */
        @media (max-width: 992px) {
            .main-content {
                flex-direction: column
            }

            .sidebar {
                width: 100%
            }

            .kanban-column {
                flex: 0 0 280px
            }
        }

        @media (max-width: 576px) {
            header {
                flex-direction: column;
                align-items: flex-start
            }

            .search-container {
                width: 100%;
                max-width: none
            }

            .content {
                padding: .9rem
            }

            .content-header {
                flex-direction: column;
                align-items: flex-start
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <i class="fas fa-project-diagram"></i>
                <h1>SiteFlow CRM</h1>
            </div>
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Поиск проектов…" />
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <div class="nav-section">
                    <h2>Основное</h2>
                    <a class="nav-item active"><i class="fas fa-th-large"></i><span>Проекты</span></a>
                </div>
                <div class="nav-section">
                    <h2>Этапы</h2>
                    <a class="nav-item" data-stage="discussion"><i
                            class="fas fa-comments"></i><span>Обсуждение</span></a>
                    <a class="nav-item" data-stage="design"><i class="fas fa-palette"></i><span>Дизайн</span></a>
                    <a class="nav-item" data-stage="layout"><i class="fas fa-code"></i><span>Верстка</span></a>
                    <a class="nav-item" data-stage="development"><i
                            class="fas fa-cogs"></i><span>Программирование</span></a>
                    <a class="nav-item" data-stage="testing"><i class="fas fa-bug"></i><span>Тестирование</span></a>
                    <a class="nav-item" data-stage="completed"><i
                            class="fas fa-check-circle"></i><span>Завершённые</span></a>
                </div>
            </aside>

            <main class="content">
                <div class="content-header">
                    <h2>Мои проекты</h2>
                    <div>
                        <button class="btn" id="exportBtn"><i class="fas fa-file-export"></i>Экспорт</button>
                        <input id="importFile" type="file" accept="application/json" hidden>
                        <button class="btn btn-primary" id="addProjectBtn"><i class="fas fa-plus"></i>Новый
                            проект</button>
                    </div>
                </div>
                <div class="kanban-board" id="kanbanBoard"></div>
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-backdrop" id="projectModal" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal-header">
                <h3 id="modalTitle">Добавить проект</h3>
                <button class="close-modal" id="closeModal" aria-label="Закрыть">&times;</button>
            </div>
            <form id="projectForm">
                <input type="hidden" id="projectId" />
                <div class="form-group">
                    <label for="projectName">Название проекта</label>
                    <input type="text" id="projectName" class="form-control" required />
                </div>
                <div class="form-group">
                    <label for="clientName">Клиент</label>
                    <input type="text" id="clientName" class="form-control" required />
                </div>
                <div class="form-group">
                    <label for="projectDescription">Описание проекта</label>
                    <textarea id="projectDescription" class="form-control"
                        placeholder="Коротко о целях/объёме"></textarea>
                </div>
                <div class="form-group">
                    <label for="projectStatus">Статус</label>
                    <select id="projectStatus" class="form-control" required>
                        <option value="discussion">Обсуждение</option>
                        <option value="design">Дизайн</option>
                        <option value="layout">Верстка</option>
                        <option value="development">Программирование</option>
                        <option value="testing">Тестирование</option>
                        <option value="completed">Завершён</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Теги</label>
                    <div style="display:flex; gap:.6rem; flex-wrap:wrap">
                        <label style="display:flex; align-items:center; gap:.35rem"><input type="checkbox"
                                id="tagUrgent" value="urgent"><span class="tag tag-urgent">Срочно</span></label>
                        <label style="display:flex; align-items:center; gap:.35rem"><input type="checkbox"
                                id="tagWaiting" value="waiting"><span class="tag tag-waiting">Ожидает</span></label>
                        <label style="display:flex; align-items:center; gap:.35rem"><input type="checkbox" id="tagPaid"
                                value="paid"><span class="tag tag-paid">Оплачено</span></label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="dueDate">Срок сдачи</label>
                    <input type="date" id="dueDate" class="form-control" />
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" id="cancelProject">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        (function () {
            // ===== Model =====
            const STORAGE_KEY = 'siteflow_projects_v2';
            const statuses = [
                { id: 'discussion', name: 'Обсуждение', icon: 'fas fa-comments' },
                { id: 'design', name: 'Дизайн', icon: 'fas fa-palette' },
                { id: 'layout', name: 'Верстка', icon: 'fas fa-code' },
                { id: 'development', name: 'Программирование', icon: 'fas fa-cogs' },
                { id: 'testing', name: 'Тестирование', icon: 'fas fa-bug' },
                { id: 'completed', name: 'Завершённые', icon: 'fas fa-check-circle' }
            ];
            let projects = [];
            let stageFilter = null; // null=все, иначе конкретный статус

            // ===== DOM refs =====
            const board = document.getElementById('kanbanBoard');
            const searchInput = document.getElementById('searchInput');
            const modal = document.getElementById('projectModal');
            const form = document.getElementById('projectForm');
            const modalTitle = document.getElementById('modalTitle');

            // ===== Init =====
            document.getElementById('addProjectBtn').addEventListener('click', () => openModal());
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelProject').addEventListener('click', closeModal);
            form.addEventListener('submit', handleFormSubmit);
            searchInput.addEventListener('input', render);
            document.getElementById('exportBtn').addEventListener('click', exportJSON);
            document.getElementById('importFile').addEventListener('change', importJSON);

            window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.style.display === 'flex') closeModal(); });
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

            load();
            render();

            // Sidebar filters
            document.querySelectorAll('.sidebar .nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const stage = item.dataset.stage || null;
                    // сброс активных
                    document.querySelectorAll('.sidebar .nav-item').forEach(i => i.classList.remove('active'));
                    if (stage !== null) {
                        stageFilter = stage;
                        item.classList.add('active');
                    } else {
                        // если это раздел "Проекты" (верхний)
                        if (item.textContent.trim() === 'Проекты') { stageFilter = null; item.classList.add('active'); }
                    }
                    render();
                });
            });

            // ===== Storage =====
            function load() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    projects = raw ? JSON.parse(raw) : getSeed();
                    save();
                } catch { projects = getSeed(); save(); }
            }
            function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(projects)); }

            function getSeed() {
                const today = new Date();
                const fmt = (d) => d.toISOString().slice(0, 10);
                return [
                    { id: uid(), name: 'Корпоративный сайт', client: 'ООО «Рога и копыта»', description: 'Лендинг новой услуги', status: 'design', tags: ['urgent'], dueDate: fmt(addDays(today, 14)), createdAt: new Date().toISOString() },
                    { id: uid(), name: 'Интернет‑магазин', client: 'ИП Иванов', description: 'Каталог + корзина', status: 'development', tags: ['paid'], dueDate: fmt(addDays(today, 30)), createdAt: new Date().toISOString() },
                    { id: uid(), name: 'Блог о путешествиях', client: 'Анна Петрова', description: 'Персональный блог', status: 'testing', tags: ['waiting'], dueDate: fmt(addDays(today, 7)), createdAt: new Date().toISOString() }
                ];
            }

            // ===== Render =====
            function render() {
                const q = (searchInput.value || '').toLowerCase();
                let filtered = !q ? projects : projects.filter(p =>
                    (p.name || '').toLowerCase().includes(q) ||
                    (p.client || '').toLowerCase().includes(q) ||
                    (p.description || '').toLowerCase().includes(q)
                );
                if (stageFilter) { filtered = filtered.filter(p => p.status === stageFilter); }

                board.innerHTML = '';
                for (const st of statuses) {
                    const col = document.createElement('div');
                    col.className = 'kanban-column';
                    col.dataset.status = st.id;

                    const items = filtered.filter(p => p.status === st.id).sort(sortByDue);
                    col.innerHTML = `
          <div class="column-header">
            <div class="column-title"><i class=\"${st.icon}\"></i><span>${st.name}</span></div>
            <div class="task-count">${items.length}</div>
          </div>
          <div class="task-list" data-list=\"${st.id}\">
            ${items.length ? items.map(renderCard).join('') :
                            `<div class=\"empty-state\"><i class=\"${st.icon}\"></i><p>Нет проектов</p></div>`}
          </div>`;
                    board.appendChild(col);
                }

                document.querySelectorAll('.sidebar .nav-item[data-stage]').forEach(el => {
                    el.classList.toggle('active', el.dataset.stage === stageFilter);
                });

                attachHandlers();
            }

            function renderCard(p) {
                const tags = (p.tags || []).map(t => tagHTML(t)).join('');
                const due = p.dueDate ? new Date(p.dueDate).toLocaleDateString('ru-RU') : 'Не указан';
                return `
      <div class="task-card" draggable="true" data-id="${p.id}">
        <div class="task-header">
          <div>
            <div class="task-title">${escapeHtml(p.name)}</div>
            <div class="task-client"><i class="fas fa-user"></i>${escapeHtml(p.client || '')}</div>
          </div>
        </div>
        <div class="task-tags">${tags}</div>
        <div class="task-footer">
          <div class="task-date"><i class="far fa-calendar-alt"></i>${due}</div>
          <div class="task-actions">
            <button class="edit-task" data-id="${p.id}" title="Редактировать"><i class="fas fa-edit"></i></button>
            <button class="delete-task" data-id="${p.id}" title="Удалить"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      </div>`;
            }

            function tagHTML(t) {
                if (t === 'urgent') return '<span class="tag tag-urgent">Срочно</span>';
                if (t === 'waiting') return '<span class="tag tag-waiting">Ожидает</span>';
                if (t === 'paid') return '<span class="tag tag-paid">Оплачено</span>';
                return '';
            }

            function sortByDue(a, b) {
                const da = a.dueDate ? new Date(a.dueDate) : new Date(8640000000000000);
                const db = b.dueDate ? new Date(b.dueDate) : new Date(8640000000000000);
                return da - db;
            }

            // ===== Handlers =====
            function attachHandlers() {
                // Edit / delete
                board.querySelectorAll('.edit-task').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const id = e.currentTarget.dataset.id; const p = projects.find(x => x.id === id); if (p) openModal(p);
                    });
                });
                board.querySelectorAll('.delete-task').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const id = e.currentTarget.dataset.id;
                        if (confirm('Удалить проект?')) { projects = projects.filter(x => x.id !== id); save(); render(); }
                    });
                });

                initDragAndDrop();
            }

            // ===== Modal =====
            function openModal(p = null) {
                modal.style.display = 'flex';
                modal.setAttribute('aria-hidden', 'false');
                form.reset();
                if (p) {
                    modalTitle.textContent = 'Редактировать проект';
                    setVal('projectId', p.id);
                    setVal('projectName', p.name || '');
                    setVal('clientName', p.client || '');
                    setVal('projectDescription', p.description || '');
                    setVal('projectStatus', p.status || 'discussion');
                    setVal('dueDate', p.dueDate || '');
                    byId('tagUrgent').checked = (p.tags || []).includes('urgent');
                    byId('tagWaiting').checked = (p.tags || []).includes('waiting');
                    byId('tagPaid').checked = (p.tags || []).includes('paid');
                } else {
                    modalTitle.textContent = 'Добавить проект';
                    setVal('projectId', '');
                    setVal('projectStatus', 'discussion');
                }
                // Focus first field
                setTimeout(() => byId('projectName').focus(), 0);
            }
            function closeModal() { modal.style.display = 'none'; modal.setAttribute('aria-hidden', 'true'); }
            form.addEventListener('submit', handleFormSubmit);

            function handleFormSubmit(e) {
                e.preventDefault();
                const id = value('projectId');
                const payload = {
                    id: id || uid(),
                    name: value('projectName').trim(),
                    client: value('clientName').trim(),
                    description: value('projectDescription').trim(),
                    status: value('projectStatus') || 'discussion',
                    tags: [byId('tagUrgent').checked && 'urgent', byId('tagWaiting').checked && 'waiting', byId('tagPaid').checked && 'paid'].filter(Boolean),
                    dueDate: value('dueDate') || '',
                    createdAt: id ? (projects.find(p => p.id === id)?.createdAt || new Date().toISOString()) : new Date().toISOString()
                };
                if (!payload.name || !payload.client) { alert('Заполни название и клиента'); return; }

                if (id) {
                    const i = projects.findIndex(p => p.id === id); if (i > -1) projects[i] = { ...projects[i], ...payload };
                } else {
                    projects.push(payload);
                }
                save(); render(); closeModal();
            }

            // ===== DnD =====
            function initDragAndDrop() {
                let dragId = null;
                board.querySelectorAll('.task-card').forEach(card => {
                    card.addEventListener('dragstart', (e) => { dragId = card.dataset.id; card.classList.add('dragging'); e.dataTransfer.setData('text/plain', dragId); e.dataTransfer.effectAllowed = 'move'; });
                    card.addEventListener('dragend', () => { dragId = null; card.classList.remove('dragging'); clearDropZones(); });
                });

                board.querySelectorAll('.kanban-column, .task-list').forEach(zone => {
                    zone.addEventListener('dragover', (e) => { e.preventDefault(); const col = e.currentTarget.closest('.kanban-column'); col.classList.add('drop-zone'); e.dataTransfer.dropEffect = 'move'; });
                    zone.addEventListener('dragleave', (e) => { const col = e.currentTarget.closest('.kanban-column'); col.classList.remove('drop-zone'); });
                    zone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const col = e.currentTarget.closest('.kanban-column');
                        if (!col || !dragId) return;
                        const status = col.dataset.status;
                        const i = projects.findIndex(p => p.id === dragId);
                        if (i > -1) { projects[i].status = status; save(); render(); }
                    });
                });
            }
            function clearDropZones() { board.querySelectorAll('.kanban-column').forEach(c => c.classList.remove('drop-zone')); }

            // ===== Export / Import =====
            function exportJSON() {
                const blob = new Blob([JSON.stringify(projects, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download = 'siteflow-projects.json'; a.click(); URL.revokeObjectURL(a.href);
            }
            function importJSON(e) {
                const f = e.target.files[0]; if (!f) return; const fr = new FileReader();
                fr.onload = () => { try { const data = JSON.parse(fr.result); if (Array.isArray(data)) { projects = data; save(); render(); } else alert('Файл должен содержать массив проектов'); } catch (err) { alert('Ошибка чтения JSON'); } };
                fr.readAsText(f); e.target.value = '';
            }

            // ===== Helpers =====
            function uid() { return Math.random().toString(36).slice(2, 10); }
            function byId(id) { return document.getElementById(id); }
            function value(id) { return byId(id).value; }
            function setVal(id, v) { byId(id).value = v; }
            function addDays(d, n) { const x = new Date(d); x.setDate(x.getDate() + n); return x; }
            function escapeHtml(s) { return (s || '').replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[m])); }
        })();
    </script>
</body>

</html>
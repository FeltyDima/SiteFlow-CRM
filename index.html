<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SiteFlow CRM — Проекты и Верификация</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="favicon.ico" sizes="any">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --info: #3b82f6;
            --radius: 8px
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.55
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh
        }

        /* header */
        header {
            background: var(--bg-secondary);
            padding: 1rem 1.25rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10
        }

        .logo {
            display: flex;
            align-items: center;
            gap: .6rem
        }

        .logo i {
            color: var(--accent);
            font-size: 1.4rem
        }

        .logo h1 {
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: .2px
        }

        .search-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: .5rem;
            max-width: 560px;
            margin-left: auto;
            position: relative
        }

        .search-container>i {
            position: absolute;
            left: .6rem;
            color: var(--text-secondary)
        }

        .search-container input {
            flex: 1;
            padding: .6rem .9rem .6rem 2.2rem;
            border-radius: 8px;
            border: 1px solid var(--bg-tertiary);
            background: var(--bg-primary);
            color: var(--text-primary);
            outline: none
        }

        /* layout */
        .main-content {
            display: flex;
            flex: 1;
            min-height: 0
        }

        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            flex-shrink: 0;
            border-right: 1px solid var(--bg-tertiary)
        }

        .nav-section h2 {
            font-size: .78rem;
            text-transform: uppercase;
            letter-spacing: .06em;
            color: var(--text-secondary);
            margin: 0 0 .5rem .25rem
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: .6rem;
            padding: .55rem .6rem;
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer
        }

        .nav-item:hover {
            background: var(--bg-tertiary)
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--accent)
        }

        .nav-item i {
            width: 1.1rem;
            text-align: center
        }

        .content {
            flex: 1;
            padding: 1rem;
            overflow: visible;
            min-width: 0
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem
        }

        .btn {
            padding: .5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--bg-tertiary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: .5rem
        }

        .btn:hover {
            background: #243046
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff
        }

        .btn-primary:hover {
            background: var(--accent-hover)
        }

        /* kanban */
        .kanban-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            overflow-y: visible;
            padding-bottom: .5rem
        }

        .kanban-column {
            flex: 0 0 300px;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: .8rem;
            display: flex;
            flex-direction: column;
            max-height: none;
            border: 1px solid var(--bg-tertiary)
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: .5rem;
            border-bottom: 1px solid var(--bg-tertiary)
        }

        .column-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: .4rem
        }

        .task-count {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: .75rem;
            padding: .1rem .45rem;
            border-radius: 10px
        }

        .task-list {
            flex: 1;
            overflow: visible;
            display: flex;
            flex-direction: column;
            gap: .7rem;
            padding-top: .7rem
        }

        .task-card {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: .75rem;
            cursor: grab;
            border: 1px solid var(--bg-tertiary)
        }

        .task-card:active {
            cursor: grabbing
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: .35rem
        }

        .task-title {
            font-weight: 600;
            margin-bottom: .1rem
        }

        .task-client {
            color: var(--text-secondary);
            font-size: .86rem;
            display: flex;
            gap: .35rem;
            align-items: center
        }

        .task-tags {
            display: flex;
            gap: .35rem;
            margin: .45rem 0 0;
            flex-wrap: wrap
        }

        .tag {
            padding: .15rem .45rem;
            border-radius: 4px;
            font-size: .74rem;
            font-weight: 600;
            border: 1px solid transparent
        }

        .tag-urgent {
            background: rgba(239, 68, 68, .12);
            color: var(--danger);
            border-color: rgba(239, 68, 68, .25)
        }

        .tag-waiting {
            background: rgba(234, 179, 8, .12);
            color: var(--warning);
            border-color: rgba(234, 179, 8, .25)
        }

        .tag-paid {
            background: rgba(34, 197, 94, .12);
            color: var(--success);
            border-color: rgba(34, 197, 94, .25)
        }

        .verification-info {
            margin: .5rem 0;
            font-size: .85rem
        }

        .verification-links {
            display: flex;
            flex-direction: column;
            gap: .4rem;
            margin: .5rem 0
        }

        .verification-link {
            display: inline-flex;
            align-items: center;
            gap: .4rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: .85rem
        }

        .verification-link:hover {
            color: var(--accent)
        }

        .bank-status {
            display: flex;
            flex-wrap: wrap;
            gap: .3rem;
            margin: .5rem 0
        }

        .bank-badge {
            padding: .2rem .5rem;
            border-radius: 4px;
            font-size: .7rem;
            font-weight: 600
        }

        .bank-open {
            background: rgba(59, 130, 246, .15);
            color: var(--info)
        }

        .bank-verification {
            background: rgba(234, 179, 8, .15);
            color: var(--warning)
        }

        .bank-success {
            background: rgba(34, 197, 94, .15);
            color: var(--success)
        }

        .bank-rejected {
            background: rgba(239, 68, 68, .15);
            color: var(--danger)
        }

        .image-previews {
            display: flex;
            gap: .5rem;
            margin-top: .5rem;
            flex-wrap: wrap
        }

        .image-preview {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid var(--bg-tertiary);
            cursor: pointer
        }

        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: .55rem;
            padding-top: .45rem;
            border-top: 1px solid var(--bg-tertiary)
        }

        .task-date {
            font-size: .8rem;
            color: var(--text-secondary);
            display: flex;
            gap: .35rem;
            align-items: center
        }

        .task-actions {
            display: flex;
            gap: .4rem
        }

        .task-actions button {
            background: none;
            border: 1px solid var(--bg-tertiary);
            color: var(--text-secondary);
            padding: .3rem .45rem;
            border-radius: 6px;
            cursor: pointer
        }

        .task-actions button:hover {
            color: var(--text-primary);
            border-color: #3b4a65
        }

        .task-card.dragging {
            opacity: .6
        }

        .kanban-column.drop-zone {
            outline: 2px dashed var(--accent);
            outline-offset: -6px
        }

        /* modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 8px;
            width: min(680px, 100%);
            max-height: 90vh;
            overflow: auto;
            padding: 1rem
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: .6rem;
            border-bottom: 1px solid var(--bg-tertiary)
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer
        }

        .close-modal:hover {
            color: #fff
        }

        .form-group {
            margin: .9rem 0
        }

        .form-group label {
            display: block;
            margin-bottom: .35rem;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: .9rem
        }

        .form-control {
            width: 100%;
            padding: .6rem .7rem;
            border-radius: 8px;
            border: 1px solid var(--bg-tertiary);
            background: var(--bg-primary);
            color: #fff;
            outline: none
        }

        .form-control:focus {
            border-color: var(--accent)
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: .6rem;
            margin-top: 1rem
        }

        .bank-inputs {
            display: flex;
            flex-direction: column;
            gap: .5rem;
            margin-top: .5rem
        }

        .bank-input-row {
            display: flex;
            gap: .5rem
        }

        .bank-input-row select,
        .bank-input-row input {
            flex: 1
        }

        .remove-bank {
            background: var(--danger);
            border: none;
            color: white;
            border-radius: 4px;
            width: 30px;
            cursor: pointer
        }

        .add-bank {
            align-self: flex-start
        }

        .image-upload {
            border: 2px dashed var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            margin-top: .5rem
        }

        .image-upload:hover {
            border-color: var(--accent)
        }

        .uploaded-images {
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
            margin-top: .5rem
        }

        .uploaded-image {
            position: relative;
            width: 100px;
            height: 100px
        }

        .uploaded-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px
        }

        .remove-image {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px
        }

        /* empty */
        .empty-state {
            text-align: center;
            padding: 1.2rem;
            color: var(--text-secondary)
        }

        .empty-state i {
            font-size: 2rem;
            margin-bottom: .4rem;
            opacity: .6
        }

        /* lightbox */
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 70
        }

        .lightbox img {
            max-width: 92vw;
            max-height: 92vh;
            border-radius: 10px;
            border: 1px solid #222
        }

        /* responsive */
        @media (max-width:992px) {
            .main-content {
                flex-direction: column
            }

            .sidebar {
                width: 100%
            }

            .kanban-column {
                flex: 0 0 280px
            }
        }

        @media (max-width:576px) {
            header {
                flex-direction: column;
                align-items: flex-start
            }

            .search-container {
                width: 100%;
                max-width: none
            }

            .content {
                padding: .9rem
            }

            .content-header {
                flex-direction: column;
                align-items: flex-start
            }

            .bank-input-row {
                flex-direction: column
            }
        }

        .bank-extra {
            background: rgba(99, 102, 241, .15);
            /* фиолетовый, под акцент */
            color: var(--accent);
        }

        .bank-todo {
            background: rgba(51, 65, 85, .25);
            /* серо-нейтральный фон */
            color: var(--text-secondary);
        }

        /* базовый вид бейджа воркера */
        .worker-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            /* было 18 */
            height: 18px;
            font-size: 0.75rem;
            font-weight: 800;
            border-radius: 50%;
            margin-right: .4rem;
            line-height: 1;
            border: 1px solid rgba(0, 0, 0, .15);
            box-shadow: 0 1px 1.5px rgba(0, 0, 0, .25);
            /* лёгкая тень */
        }

        /* цветовые варианты — хороший контраст на тёмной теме */
        .worker-sanya {
            background: #2563eb;
            /* indigo-600 */
            color: #fff;
            border-color: rgba(37, 99, 235, .6);
        }

        .worker-rusik {
            background: #16a34a;
            /* green-600 */
            color: #fff;
            border-color: rgba(22, 163, 74, .6);
        }

        .worker-egor {
            background: #a855f7;
            /* purple-500/600 */
            color: #fff;
            border-color: rgba(168, 85, 247, .6);
        }

        /* если хочешь ещё чуть «приподнять» весь бейдж банка, добавь: */
        .bank-badge {
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .04);
        }

        .worker-dima {
            background: #f59e0b;
            /* amber-500 */
            color: #fff;
            border-color: rgba(245, 158, 11, .6);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header>
            <div class="logo"><i class="fas fa-project-diagram"></i>
                <h1>SiteFlow CRM</h1>
            </div>
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Поиск…" />
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <div class="nav-section">
                    <h2>Основное</h2>
                    <a class="nav-item active" data-page="projects"><i
                            class="fas fa-th-large"></i><span>Сайты</span></a>
                    <a class="nav-item" data-page="verification"><i
                            class="fas fa-shield-alt"></i><span>Дропики</span></a>
                    <a class="nav-item" data-page="payouts"><i class="fas fa-coins"></i><span>Выплаты</span></a>
                </div>
            </aside>

            <main class="content">
                <!-- Projects -->
                <div id="projects-view" class="content-view">
                    <div class="content-header">
                        <h2>Сайты</h2>
                        <div>
                            <button class="btn" id="exportBtn"><i class="fas fa-file-export"></i>Экспорт</button>
                            <input id="importFile" type="file" accept="application/json" hidden>
                            <button class="btn" id="importBtn"><i class="fas fa-file-import"></i>Импорт</button>
                            <button class="btn btn-primary" id="addProjectBtn"><i class="fas fa-plus"></i>Новый
                                сайт</button>

                        </div>
                    </div>
                    <div class="kanban-board" id="kanbanBoard"></div>
                </div>

                <!-- Verification -->
                <div id="verification-view" class="content-view" style="display:none">
                    <div class="content-header">
                        <h2>Дропики</h2>
                        <div>
                            <button class="btn" id="exportVerificationBtn"><i
                                    class="fas fa-file-export"></i>Экспорт</button>
                            <input id="importVerificationFile" type="file" accept="application/json" hidden>
                            <button class="btn" id="importVerificationBtn"><i
                                    class="fas fa-file-import"></i>Импорт</button>
                            <button class="btn btn-primary" id="addVerificationBtn"><i class="fas fa-plus"></i>Новая
                                заявка</button>
                        </div>
                    </div>
                    <div class="kanban-board" id="verificationBoard"></div>
                </div>

                <div id="payouts-view" class="content-view" style="display:none">
                    <div class="content-header">
                        <h2>Выплаты</h2>
                        <div>
                            <button class="btn" id="exportPayoutsBtn"><i class="fas fa-file-export"></i>Экспорт</button>
                            <input id="importPayoutsFile" type="file" accept="application/json" hidden>
                            <button class="btn" id="importPayoutsBtn"><i class="fas fa-file-import"></i>Импорт</button>
                            <button class="btn btn-primary" id="addPayoutBtn"><i class="fas fa-plus"></i>Новая
                                выплата</button>
                        </div>
                    </div>
                    <div class="kanban-board" id="payoutsBoard"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal-backdrop" id="projectModal" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="projectModalTitle">
            <div class="modal-header">
                <h3 id="projectModalTitle">Добавить сайт</h3>
                <button class="close-modal" id="closeProjectModal" aria-label="Закрыть">&times;</button>
            </div>
            <form id="projectForm">
                <input type="hidden" id="projectId" />
                <div class="form-group"><label for="projectName">Название проекта</label><input type="text"
                        id="projectName" class="form-control" required /></div>
                <div class="form-group">
                    <label for="projectSiteUrl">Сайт (URL)</label>
                    <input type="url" id="projectSiteUrl" class="form-control" placeholder="https://..." />
                </div>
                <div class="form-group">
                    <label for="projectRegistryUrl">Ссылка на реестр</label>
                    <input type="url" id="projectRegistryUrl" class="form-control" placeholder="https://..." />
                </div>
                <div class="form-group"><label for="projectDescription">Описание сайта</label><textarea
                        id="projectDescription" class="form-control" placeholder="Коротко о целях/объёме"></textarea>
                </div>
                <div class="form-group"><label for="projectStatus">Статус</label>
                    <select id="projectStatus" class="form-control" required>
                        <option value="todo">Ожидает работы</option>
                        <option value="doing">В работе</option>
                        <option value="applied">Оплачено</option>
                        <option value="not_applied">Не оплачено</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Теги</label>
                    <div style="display:flex; gap:.6rem; flex-wrap:wrap">
                        <label style="display:flex; align-items:center; gap:.35rem"><input type="checkbox"
                                id="tagUrgent" value="urgent"><span class="tag tag-urgent">Срочно</span></label>
                        <label style="display:flex; align-items:center; gap:.35rem"><input type="checkbox"
                                id="tagWaiting" value="waiting"><span class="tag tag-waiting">Ожидает</span></label>
                        <label style="display:flex; align-items:center; gap:.35rem"><input type="checkbox" id="tagPaid"
                                value="paid"><span class="tag tag-paid">Оплачено</span></label>
                    </div>
                </div>
                <div class="form-group"><label for="dueDate">Срок сдачи</label><input type="date" id="dueDate"
                        class="form-control" /></div>
                <div class="form-actions"><button type="button" class="btn" id="cancelProject">Отмена</button><button
                        type="submit" class="btn btn-primary">Сохранить</button></div>
            </form>
        </div>
    </div>

    <!-- Verification Modal -->
    <div class="modal-backdrop" id="verificationModal" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="verificationModalTitle">
            <div class="modal-header">
                <h3 id="verificationModalTitle">Добавить заявку на верификацию</h3>
                <button class="close-modal" id="closeVerificationModal" aria-label="Закрыть">&times;</button>
            </div>
            <form id="verificationForm">
                <input type="hidden" id="verificationId" />
                <div class="form-group" style="display:flex; gap:.5rem; align-items:flex-end;">
                    <div style="flex:1">
                        <label for="dropName">Имя дропа</label>
                        <input type="text" id="dropName" class="form-control" required />
                    </div>
                    <div style="width:120px">
                        <label for="dropFlag">Флаг</label>
                        <input type="text" id="dropFlag" class="form-control" placeholder="🇷🇺 или RU" maxlength="8" />
                    </div>
                </div>
                <div class="form-group"><label for="siteUrl">Ссылка на сайт</label><input type="url" id="siteUrl"
                        class="form-control" required /></div>
                <div class="form-group"><label for="registryUrl">Ссылка на реестр компании</label><input type="url"
                        id="registryUrl" class="form-control" /></div>

                <div class="form-group">
                    <label>Банки и статусы</label>
                    <div class="bank-inputs" id="bankInputs"></div>
                    <button type="button" class="btn add-bank" id="addBankBtn"><i class="fas fa-plus"></i> Добавить
                        банк</button>
                </div>

                <div class="form-group">
                    <label for="verificationStatus">Статус верификации</label>
                    <select id="verificationStatus" class="form-control" required>
                        <option value="todo">Ожидает работы</option>
                        <option value="doing">В работе</option>
                        <option value="success">Успех</option>
                        <option value="rejected">Отклонено</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Фотографии (до 6, сжимаются и грузятся в Storage)</label>
                    <div class="image-upload" id="imageUpload">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Перетащите сюда файлы или кликните для выбора</p>
                        <input type="file" id="imageInput" multiple accept="image/*" style="display:none">
                    </div>
                    <div class="uploaded-images" id="uploadedImages"></div>
                </div>

                <div class="form-group"><label for="verificationNotes">Примечания</label>
                    <textarea id="verificationNotes" class="form-control"
                        placeholder="Дополнительная информация о процессе верификации"></textarea>
                </div>
                <div class="form-actions"><button type="button" class="btn"
                        id="cancelVerification">Отмена</button><button type="submit"
                        class="btn btn-primary">Сохранить</button></div>
            </form>
        </div>
    </div>

    <!-- Payout Modal -->
    <div class="modal-backdrop" id="payoutModal" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="payoutModalTitle">
            <div class="modal-header">
                <h3 id="payoutModalTitle">Добавить выплату</h3>
                <button class="close-modal" id="closePayoutModal" aria-label="Закрыть">&times;</button>
            </div>
            <form id="payoutForm">
                <input type="hidden" id="payoutId" />
                <div class="form-group">
                    <label for="payoutWorker">Кому</label>
                    <select id="payoutWorker" class="form-control" required>
                        <option value="sanya">Саня</option>
                        <option value="rusik">Русик</option>
                        <option value="egor">Егор</option>
                        <option value="dima">Дима</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payoutAmount">Сколько выплатил</label>
                    <input type="number" step="0.01" id="payoutAmount" class="form-control" placeholder="0.00"
                        required />
                </div>
                <div class="form-group">
                    <label for="payoutCurrency">Валюта</label>
                    <select id="payoutCurrency" class="form-control" required>
                        <option value="RUB">₽ Рубли</option>
                        <option value="EUR">€ Евро</option>
                        <option value="USD">$ Доллары</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payoutReason">За что выплатил</label>
                    <input type="text" id="payoutReason" class="form-control" placeholder="Описание (за что)"
                        required />
                </div>
                <div class="form-group">
                    <label for="payoutDate">Дата выплаты</label>
                    <input type="date" id="payoutDate" class="form-control" required />
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" id="cancelPayout">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox"><img alt=""></div>

    <script>
        (async function () {
            /* === Supabase config === */
            const SUPABASE_URL = "https://nwoddrbiyphemunpsfvk.supabase.co";            // ← вставь своё
            const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53b2RkcmJpeXBoZW11bnBzZnZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2ODQzMzAsImV4cCI6MjA3NTI2MDMzMH0.JNwXMkxwECc0OjtKzNT_RBcPXhaxccFNRc5Y_bC4sJ4";                            // ← вставь своё
            const STORAGE_BUCKET = "verification-images";                            // имя публичного бакета
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);


            /* Statuses */
            const projectStatuses = [
                { id: 'todo', name: 'Ожидает работы', icon: 'fas fa-inbox' },
                { id: 'doing', name: 'В работе', icon: 'fas fa-cogs' },
                { id: 'applied', name: 'Оплачены', icon: 'fas fa-check' },
                { id: 'not_applied', name: 'Не оплачены', icon: 'fas fa-times' }
            ];
            const verificationStatuses = [
                { id: 'todo', name: 'Общие', icon: 'fas fa-inbox' },
                { id: 'doing', name: 'санька', icon: 'fas fa-check-circle' },
                { id: 'success', name: 'егора', icon: 'fas fa-check-circle' },
                { id: 'rejected', name: 'русика', icon: 'fas fa-check-circle' }
            ];
            const bankStatuses = [
                { id: 'open', name: 'Открыто', class: 'bank-open' },
                { id: 'rejected', name: 'Отказ', class: 'bank-rejected' },
                { id: 'waiting', name: 'Ждем ответ', class: 'bank-waiting' },
                { id: 'need_verify', name: 'Нужен вериф', class: 'bank-verification' }, // используем существующий стиль
                { id: 'extra_request', name: 'Доп запрос', class: 'bank-extra' },        // новый стиль
                { id: 'sold', name: 'Продано', class: 'bank-success' },      // используем существующий стиль
                { id: 'todo', name: 'Нужно сделать', class: 'bank-todo' }          // новый стиль
            ];
            const workers = [
                { id: 'sanya', name: 'Саня', initial: 'С' },
                { id: 'rusik', name: 'Русик', initial: 'Р' },
                { id: 'egor', name: 'Егор', initial: 'Е' },
                { id: 'dima', name: 'Дима', initial: 'Д' }, // ← остаётся для выплат, бэйджей и пр.
            ];
            const bankWorkers = workers.filter(w => w.id !== 'dima'); // <- тут Димы уже нет
            const BANKS = [
                { id: 'finom', name: 'FINOM' },
                { id: 'airwallex', name: 'AIRWALLEX' },
                { id: 'sokin', name: 'SOKIN' },
                { id: 'narvi', name: 'NARVI' },
                { id: 'paydo', name: 'PAYDO' },
                { id: 'payio', name: 'PAYIO' },
                { id: 'wirex', name: 'WIREX' },
                { id: 'payset', name: 'PAYSET' },
                { id: 'currenxie', name: 'CURRENXIE' },
            ];

            const CURRENCIES = [
                { id: 'RUB', label: '₽ Рубли' },
                { id: 'EUR', label: '€ Евро' },
                { id: 'USD', label: '$ Доллары' },
            ];

            function currencySymbol(cur) {
                switch ((cur || 'RUB').toUpperCase()) {
                    case 'RUB': return '₽';
                    case 'EUR': return '€';
                    case 'USD': return '$';
                    default: return '';
                }
            }

            function bankIdByNameLoose(txt) {
                if (!txt) return '';
                const s = String(txt).trim().toLowerCase();
                // точное совпадение id
                const byId = BANKS.find(b => b.id === s);
                if (byId) return byId.id;
                // по названию (без регистра)
                const byName = BANKS.find(b => b.name.toLowerCase() === s);
                if (byName) return byName.id;
                // эвристика: убираем пробелы/дефисы
                const norm = s.replace(/[\s\-_.]/g, '');
                const byLoose = BANKS.find(b => b.name.toLowerCase().replace(/[\s\-_.]/g, '') === norm);
                return byLoose ? byLoose.id : '';
            }

            function bankLabelById(id) {
                const b = BANKS.find(x => x.id === id);
                return b ? b.name : '';
            }

            function normalizeWorkerId(w) {
                if (!w) return '';
                const map = {
                    sanya: 'sanya', 'саня': 'sanya',
                    rusik: 'rusik', 'русик': 'rusik',
                    egor: 'egor', 'егор': 'egor',
                    dima: 'dima', 'дима': 'dima',
                };
                const key = String(w).trim().toLowerCase();
                return map[key] || '';
            }

            function workerLabel(wid) {
                const w = workers.find(x => x.id === wid);
                return w ? w.name : '';
            }

            function workerInitial(wid) {
                const w = workers.find(x => x.id === wid);
                return w ? w.initial : '';
            }

            /* State */
            let projects = [];
            let verificationRequests = [];
            let payouts = [];
            let currentView = 'projects';

            /* Refs */
            const projectsView = $('#projects-view');
            const verificationView = $('#verification-view');
            const projectsBoard = $('#kanbanBoard');
            const verificationBoard = $('#verificationBoard');
            const searchInput = $('#searchInput');
            const projectModal = $('#projectModal');
            const verificationModal = $('#verificationModal');
            const projectForm = $('#projectForm');
            const verificationForm = $('#verificationForm');
            const bankInputs = $('#bankInputs');
            const imageUpload = $('#imageUpload');
            const imageInput = $('#imageInput');
            const uploadedImages = $('#uploadedImages');
            const lightbox = $('#lightbox');
            const payoutsView = $('#payouts-view');
            const payoutsBoard = $('#payoutsBoard');
            const payoutModal = $('#payoutModal');
            const payoutForm = $('#payoutForm');

            /* Init UI */
            $('#addProjectBtn').addEventListener('click', () => openProjectModal());
            $('#addVerificationBtn').addEventListener('click', () => openVerificationModal());
            $('#closeProjectModal').addEventListener('click', closeProjectModal);
            $('#closeVerificationModal').addEventListener('click', closeVerificationModal);
            $('#cancelProject').addEventListener('click', closeProjectModal);
            $('#cancelVerification').addEventListener('click', closeVerificationModal);
            $('#addPayoutBtn').addEventListener('click', () => openPayoutModal());
            $('#closePayoutModal').addEventListener('click', closePayoutModal);
            $('#cancelPayout').addEventListener('click', closePayoutModal);
            projectForm.addEventListener('submit', handleProjectFormSubmit);
            verificationForm.addEventListener('submit', handleVerificationFormSubmit);
            searchInput.addEventListener('input', debounce(render, 200));
            payoutForm.addEventListener('submit', handlePayoutFormSubmit);

            // экспорт/импорт
            $('#exportBtn').addEventListener('click', () => downloadJSON(projects, 'siteflow-sites.json'));
            $('#exportVerificationBtn').addEventListener('click', () => downloadJSON(verificationRequests, 'siteflow-verification.json'));
            $('#importBtn').addEventListener('click', () => $('#importFile').click());
            $('#importVerificationBtn').addEventListener('click', () => $('#importVerificationFile').click());
            $('#importFile').addEventListener('change', importProjects);
            $('#importVerificationFile').addEventListener('change', importVerification);
            $('#exportPayoutsBtn').addEventListener('click', () => downloadJSON(payouts, 'siteflow-payouts.json'));
            $('#importPayoutsBtn').addEventListener('click', () => $('#importPayoutsFile').click());
            $('#importPayoutsFile').addEventListener('change', importPayouts);

            $('#addBankBtn').addEventListener('click', () => addBankInput());

            // image upload area
            imageUpload.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', onImagesChosen);
            ['dragenter', 'dragover'].forEach(ev => imageUpload.addEventListener(ev, e => { e.preventDefault(); imageUpload.style.borderColor = '#7aa2ff'; }));
            ['dragleave', 'drop'].forEach(ev => imageUpload.addEventListener(ev, e => { e.preventDefault(); imageUpload.style.borderColor = ''; }));
            imageUpload.addEventListener('drop', (e) => {
                const dt = e.dataTransfer; if (!dt?.files?.length) return; handleImageFiles(Array.from(dt.files));
            });

            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (projectModal.style.display === 'flex') closeProjectModal();
                    if (verificationModal.style.display === 'flex') closeVerificationModal();
                    if (lightbox.style.display === 'flex') lightbox.style.display = 'none';
                }
            });
            projectModal.addEventListener('click', e => { if (e.target === projectModal) closeProjectModal(); });
            verificationModal.addEventListener('click', e => { if (e.target === verificationModal) closeVerificationModal(); });
            lightbox.addEventListener('click', () => lightbox.style.display = 'none');

            // view nav
            $all('.sidebar .nav-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    $all('.sidebar .nav-item[data-page]').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const page = item.dataset.page;
                    if (page === 'projects') {
                        currentView = 'projects';
                        projectsView.style.display = '';
                        verificationView.style.display = 'none';
                        payoutsView.style.display = 'none';
                    } else if (page === 'verification') {
                        currentView = 'verification';
                        projectsView.style.display = 'none';
                        verificationView.style.display = '';
                        payoutsView.style.display = 'none';
                    } else {
                        currentView = 'payouts';
                        projectsView.style.display = 'none';
                        verificationView.style.display = 'none';
                        payoutsView.style.display = '';
                    }
                    render();
                });
            });

            /* DB I/O */
            async function load() {
                const { data: pData, error: pErr } = await supabase.from('projects').select('*').order('created_at', { ascending: true });
                if (pErr) { console.error(pErr); alert('Не удалось загрузить сайты'); }
                const { data: vData, error: vErr } = await supabase.from('verifications').select('*').order('created_at', { ascending: true });
                if (vErr) { console.error(vErr); alert('Не удалось загрузить заявки'); }
                projects = pData || [];
                verificationRequests = vData || [];
                const { data: payData, error: payErr } = await supabase.from('payouts').select('*').order('created_at', { ascending: true });
                if (payErr) { console.error(payErr); alert('Не удалось загрузить выплаты'); }
                payouts = payData || [];
            }

            async function saveProject(p) {
                const { error } = await supabase.from('projects').upsert(p);
                if (error) { console.error(error); alert('Не удалось сохранить сайт'); }
            }

            async function deleteProjectDB(id) {
                const { error } = await supabase.from('projects').delete().eq('id', id);
                if (error) { console.error(error); alert('Не удалось удалить сайт'); }
            }

            async function saveVerification(v) {
                const { error } = await supabase.from('verifications').upsert(v);
                if (error) { console.error(error); alert('Не удалось сохранить заявку'); }
            }

            async function deleteVerificationDB(id) {
                const { error } = await supabase.from('verifications').delete().eq('id', id);
                if (error) { console.error(error); alert('Не удалось удалить заявку'); }
            }

            async function savePayout(p) {
                const { error } = await supabase.from('payouts').upsert(p);
                if (error) { console.error(error); alert('Не удалось сохранить выплату'); }
            }
            async function deletePayoutDB(id) {
                const { error } = await supabase.from('payouts').delete().eq('id', id);
                if (error) { console.error(error); alert('Не удалось удалить выплату'); }
            }

            function startRealtime() {
                supabase.channel('projects-realtime')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, async () => {
                        const { data } = await supabase.from('projects').select('*').order('created_at');
                        projects = data || []; render();
                    })
                    .subscribe();

                supabase.channel('verifications-realtime')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'verifications' }, async () => {
                        const { data } = await supabase.from('verifications').select('*').order('created_at');
                        verificationRequests = data || []; render();
                    })
                    .subscribe();

                supabase.channel('payouts-realtime')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'payouts' }, async () => {
                        const { data } = await supabase.from('payouts').select('*').order('created_at', { ascending: true });
                        payouts = data || []; render();
                    })
                    .subscribe();
            }

            /* Render */
            function render() {
                if (currentView === 'projects') renderProjects();
                else if (currentView === 'verification') renderVerification();
                else renderPayouts();
            }

            function renderProjects() {
                const q = (searchInput.value || '').toLowerCase();
                let filtered = q ? projects.filter(p =>
                    (p.name || '').toLowerCase().includes(q) ||
                    (p.site_url || '').toLowerCase().includes(q) ||
                    (p.registry_url || '').toLowerCase().includes(q) ||
                    (p.description || '').toLowerCase().includes(q)
                ) : projects.slice();

                projectsBoard.innerHTML = '';
                for (const st of projectStatuses) {
                    const col = div('kanban-column'); col.dataset.status = st.id;
                    const items = filtered.filter(p => p.status === st.id).sort(sortByDue);
                    col.innerHTML = `
        <div class="column-header">
          <div class="column-title"><i class="${st.icon}"></i><span>${st.name}</span></div>
          <div class="task-count">${items.length}</div>
        </div>
        <div class="task-list" data-list="${st.id}">
          ${items.length ? items.map(renderProjectCard).join('') : `<div class="empty-state"><i class="${st.icon}"></i><p>Нет проектов</p></div>`}
        </div>`;
                    projectsBoard.appendChild(col);
                }
                attachProjectHandlers();
            }

            function renderVerification() {
                const q = (searchInput.value || '').toLowerCase();
                let filtered = verificationRequests.filter(v => {
                    const inBanks = (v.banks || []).some(b => (b.name || '').toLowerCase().includes(q));
                    return !q || (v.drop_name || '').toLowerCase().includes(q) || (v.site_url || '').toLowerCase().includes(q) || (v.notes || '').toLowerCase().includes(q) || inBanks;
                });

                verificationBoard.innerHTML = '';
                for (const st of verificationStatuses) {
                    const col = div('kanban-column'); col.dataset.status = st.id;
                    const items = filtered.filter(v => v.status === st.id).sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    col.innerHTML = `
        <div class="column-header">
          <div class="column-title"><i class="${st.icon}"></i><span>${st.name}</span></div>
          <div class="task-count">${items.length}</div>
        </div>
        <div class="task-list" data-list="${st.id}">
          ${items.length ? items.map(renderVerificationCard).join('') : `<div class="empty-state"><i class="${st.icon}"></i><p>Нет заявок</p></div>`}
        </div>`;
                    verificationBoard.appendChild(col);
                }
                attachVerificationHandlers();
                $all('#verificationBoard .image-preview').forEach(img => {
                    img.addEventListener('click', () => showLightbox(img.src));
                });
            }

            function renderProjectCard(p) {
                const tags = (p.tags || []).map(t => tagHTML(t)).join('');
                const due = p.due_date ? new Date(p.due_date).toLocaleDateString('ru-RU') : 'Не указан';
                return `
      <div class="task-card" draggable="true" data-id="${p.id}">
        <div class="task-header">
          <div>
            <div class="task-title">${esc(p.name)}</div>
            ${p.site_url ? `<div class="task-client"><i class="fas fa-globe"></i>${linkMasked(p.site_url, 'Сайт')}</div>` : ''}
            ${p.registry_url ? `<div class="task-client"><i class="fas fa-file-contract"></i>${linkMasked(p.registry_url, 'Реестр')}</div>` : ''}
          </div>
        </div>
        ${p.description ? `<div class="verification-info">${esc(p.description)}</div>` : ''}
        <div class="task-tags">${tags}</div>
        <div class="task-footer">
          <div class="task-date"><i class="far fa-calendar-alt"></i>${due}</div>
          <div class="task-actions">
            <button class="edit-task" data-id="${p.id}" title="Редактировать"><i class="fas fa-edit"></i></button>
            <button class="delete-task" data-id="${p.id}" title="Удалить"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      </div>`;
            }

            function renderVerificationCard(v) {
                const bankBadges = (v.banks || []).map(bank => {
                    const st = normalizeBankStatus(bank.status);
                    const b = bankStatuses.find(s => s.id === st);
                    const cls = b?.class || 'bank-open';
                    const label = b?.name || '—';
                    const bankDisplay = bank.name || bankLabelById(bank.bank_id) || (bank.bank_id || '—').toUpperCase();

                    // воркер
                    const wid = normalizeWorkerId(bank.worker);
                    const wInit = workerInitial(wid);
                    const wClass = wid ? `worker-${wid}` : '';
                    const workerBadge = wInit
                        ? `<span class="worker-badge ${wClass}" title="${workerLabel(wid)}">${wInit}</span>`
                        : '';

                    return `<span class="bank-badge ${cls}">${workerBadge}${esc(bankDisplay)}: ${label}</span>`;
                }).join('');
                const imagePreviews = (v.images || []).slice(0, 4).map(src => `<img src="${src}" class="image-preview" alt="Preview">`).join('');
                const date = new Date(v.created_at).toLocaleString('ru-RU');
                return `
      <div class="task-card" draggable="true" data-id="${v.id}">
        <div class="task-header">
          <div>
            <div class="task-title">${esc(v.drop_name)}</div>
            ${v.site_url ? `<div class="task-client"><i class="fas fa-globe"></i>${linkMasked(v.site_url, 'Сайт')}</div>` : ''}
            ${v.registry_url ? `<div class="task-client"><i class="fas fa-file-contract"></i>${linkMasked(v.registry_url, 'Реестр')}</div>` : ''}
          </div>
        </div>
        <div class="bank-status">${bankBadges}</div>
        ${v.notes ? `<div class="verification-info">${esc(v.notes)}</div>` : ''}
        ${imagePreviews ? `<div class="image-previews">${imagePreviews}</div>` : ''}
        <div class="task-footer">
          <div class="task-date"><i class="far fa-clock"></i>${date}</div>
          <div class="task-actions">
            <button class="edit-verification" data-id="${v.id}" title="Редактировать"><i class="fas fa-edit"></i></button>
            <button class="delete-verification" data-id="${v.id}" title="Удалить"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      </div>`;
            }

            function renderPayouts() {
                const q = (searchInput.value || '').toLowerCase();
                let filtered = q
                    ? payouts.filter(p =>
                        (workerLabel(p.worker_id) || '').toLowerCase().includes(q) ||
                        String(p.amount || '').toLowerCase().includes(q) ||
                        (p.reason || '').toLowerCase().includes(q)
                    )
                    : payouts.slice();

                // 4 колонки — по воркерам
                const cols = [
                    { id: 'sanya', name: 'Саня', icon: 'fas fa-user' },
                    { id: 'rusik', name: 'Русик', icon: 'fas fa-user' },
                    { id: 'egor', name: 'Егор', icon: 'fas fa-user' },
                    { id: 'dima', name: 'Дима', icon: 'fas fa-user' },
                ];

                payoutsBoard.innerHTML = '';
                for (const c of cols) {
                    const col = div('kanban-column'); col.dataset.status = c.id; // используем status как worker_id
                    const items = filtered.filter(p => p.worker_id === c.id).sort((a, b) => new Date(b.date || b.created_at) - new Date(a.date || a.created_at));
                    col.innerHTML = `
      <div class="column-header">
        <div class="column-title"><i class="${c.icon}"></i><span>${c.name}</span></div>
        <div class="task-count">${items.length}</div>
      </div>
      <div class="task-list" data-list="${c.id}">
        ${items.length ? items.map(renderPayoutCard).join('') : `<div class="empty-state"><i class="${c.icon}"></i><p>Нет выплат</p></div>`}
      </div>`;
                    payoutsBoard.appendChild(col);
                }
                attachPayoutHandlers();
            }

            function renderPayoutCard(p) {
                const d = p.date ? new Date(p.date).toLocaleDateString('ru-RU') : (p.created_at ? new Date(p.created_at).toLocaleDateString('ru-RU') : '—');
                const amount = Number(p.amount || 0);
                const cur = (p.currency || 'RUB').toUpperCase();
                const sym = currencySymbol(cur);
                const money = isFinite(amount)
                    ? `${amount.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${sym}`
                    : `${esc(String(p.amount || ''))}`;
                const wid = normalizeWorkerId(p.worker_id);
                const wInit = workerInitial(wid), wClass = wid ? `worker-${wid}` : '';
                const workerBadge = wInit ? `<span class="worker-badge ${wClass}" title="${workerLabel(wid)}">${wInit}</span>` : '';

                return `
  <div class="task-card" draggable="true" data-id="${p.id}">
    <div class="task-header">
      <div>
        <div class="task-title">${workerBadge}${money}</div>
        ${p.reason ? `<div class="task-client"><i class="fas fa-comment-dollar"></i>${esc(p.reason)}</div>` : ''}
      </div>
    </div>
    <div class="task-footer">
      <div class="task-date"><i class="far fa-calendar-alt"></i>${d}</div>
      <div class="task-actions">
        <button class="edit-payout" data-id="${p.id}" title="Редактировать"><i class="fas fa-edit"></i></button>
        <button class="delete-payout" data-id="${p.id}" title="Удалить"><i class="fas fa-trash"></i></button>
      </div>
    </div>
  </div>`;
            }


            function tagHTML(t) {
                if (t === 'urgent') return '<span class="tag tag-urgent">Срочно</span>';
                if (t === 'waiting') return '<span class="tag tag-waiting">Ожидает</span>';
                if (t === 'paid') return '<span class="tag tag-paid">Оплачено</span>';
                return '';
            }
            function sortByDue(a, b) {
                const da = a.due_date ? new Date(a.due_date) : new Date(8640000000000000);
                const db = b.due_date ? new Date(b.due_date) : new Date(8640000000000000);
                return da - db;
            }

            /* Handlers */
            function attachProjectHandlers() {
                $all('#kanbanBoard .edit-task').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const id = e.currentTarget.dataset.id;
                        const p = projects.find(x => x.id === id);
                        if (p) openProjectModal(p);
                    });
                });
                $all('#kanbanBoard .delete-task').forEach(btn => {
                    btn.addEventListener('click', async e => {
                        const id = e.currentTarget.dataset.id;
                        if (confirm('Удалить сайт?')) {
                            projects = projects.filter(x => x.id !== id);
                            render();
                            await deleteProjectDB(id);
                        }
                    });
                });
                initDragAndDrop(projectsBoard, async (dragId, status) => {
                    const i = projects.findIndex(p => p.id === dragId);
                    if (i > -1) { projects[i].status = status; render(); await saveProject(projects[i]); }
                });
            }

            function attachVerificationHandlers() {
                $all('#verificationBoard .edit-verification').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const id = e.currentTarget.dataset.id;
                        const v = verificationRequests.find(x => x.id === id);
                        if (v) openVerificationModal(v);
                    });
                });
                $all('#verificationBoard .delete-verification').forEach(btn => {
                    btn.addEventListener('click', async e => {
                        const id = e.currentTarget.dataset.id;
                        if (confirm('Удалить заявку на верификацию?')) {
                            verificationRequests = verificationRequests.filter(x => x.id !== id);
                            render();
                            await deleteVerificationDB(id);
                        }
                    });
                });
                initDragAndDrop(verificationBoard, async (dragId, status) => {
                    const i = verificationRequests.findIndex(v => v.id === dragId);
                    if (i > -1) { verificationRequests[i].status = status; render(); await saveVerification(verificationRequests[i]); }
                });
            }

            function attachPayoutHandlers() {
                $all('#payoutsBoard .edit-payout').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const id = e.currentTarget.dataset.id;
                        const p = payouts.find(x => x.id === id);
                        if (p) openPayoutModal(p);
                    });
                });

                $all('#payoutsBoard .delete-payout').forEach(btn => {
                    btn.addEventListener('click', async e => {
                        const id = e.currentTarget.dataset.id;
                        if (confirm('Удалить выплату?')) {
                            payouts = payouts.filter(x => x.id !== id);
                            render();
                            await deletePayoutDB(id);
                        }
                    });
                });

                // Перетаскивание карточек между колонками: меняем worker_id
                initDragAndDrop(payoutsBoard, async (dragId, workerId) => {
                    const i = payouts.findIndex(x => x.id === dragId);
                    if (i > -1) {
                        payouts[i].worker_id = workerId;
                        render();
                        await savePayout(payouts[i]);
                    }
                });
            }

            function initDragAndDrop(container, onDropCb) {
                let dragId = null;
                $all('.task-card', container).forEach(card => {
                    card.addEventListener('dragstart', e => {
                        dragId = card.dataset.id;
                        card.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', dragId);
                        e.dataTransfer.effectAllowed = 'move';
                    });
                    card.addEventListener('dragend', () => {
                        dragId = null; card.classList.remove('dragging'); clearDropZones(container);
                    });
                });
                $all('.kanban-column, .task-list', container).forEach(zone => {
                    zone.addEventListener('dragover', e => {
                        e.preventDefault();
                        const col = zone.closest('.kanban-column');
                        col.classList.add('drop-zone'); e.dataTransfer.dropEffect = 'move';
                    });
                    zone.addEventListener('dragleave', e => {
                        const col = zone.closest('.kanban-column'); col.classList.remove('drop-zone');
                    });
                    zone.addEventListener('drop', e => {
                        e.preventDefault();
                        const col = zone.closest('.kanban-column');
                        if (!col) return;
                        const status = col.dataset.status;
                        onDropCb(dragId, status);
                    });
                });
            }
            function clearDropZones(container) { $all('.kanban-column', container).forEach(c => c.classList.remove('drop-zone')); }

            /* Modals */
            function openProjectModal(p = null) {
                projectForm.reset();
                if (p) {
                    $('#projectModalTitle').textContent = 'Редактировать сайт';
                    setVal('projectId', p.id);
                    setVal('projectName', p.name || '');
                    setVal('projectSiteUrl', p.site_url || '');
                    setVal('projectRegistryUrl', p.registry_url || '');
                    setVal('projectDescription', p.description || '');
                    setVal('projectStatus', p.status || 'todo');
                    setVal('dueDate', p.due_date || '');
                    $('#tagUrgent').checked = (p.tags || []).includes('urgent');
                    $('#tagWaiting').checked = (p.tags || []).includes('waiting');
                    $('#tagPaid').checked = (p.tags || []).includes('paid');
                } else {
                    $('#projectModalTitle').textContent = 'Добавить сайт';
                    setVal('projectId', ''); setVal('projectStatus', 'todo');
                }
                showModal(projectModal); setTimeout(() => $('#projectName').focus(), 0);
            }
            function closeProjectModal() { hideModal(projectModal); }

            async function handleProjectFormSubmit(e) {
                e.preventDefault();
                const id = val('projectId');
                const payload = {
                    id: id || uid(),
                    name: val('projectName').trim(),
                    site_url: val('projectSiteUrl').trim(),
                    registry_url: val('projectRegistryUrl').trim(),
                    description: val('projectDescription').trim(),
                    status: val('projectStatus') || 'todo',
                    tags: [$('#tagUrgent').checked && 'urgent', $('#tagWaiting').checked && 'waiting', $('#tagPaid').checked && 'paid'].filter(Boolean),
                    due_date: nullIfEmpty(val('dueDate')),
                    created_at: id ? (projects.find(x => x.id === id)?.created_at || new Date().toISOString()) : new Date().toISOString(),
                };
                if (!payload.name) { alert('Заполни название проекта'); return; }

                // оптимистическое обновление
                const i = projects.findIndex(x => x.id === payload.id);
                if (i > -1) projects[i] = payload; else projects.push(payload);
                render();

                await saveProject(payload);  // бекенд
                closeProjectModal();
            }

            function openVerificationModal(v = null) {
                verificationForm.reset();
                bankInputs.innerHTML = ''; uploadedImages.innerHTML = '';
                if (v) {
                    $('#verificationModalTitle').textContent = 'Редактировать заявку на верификацию';
                    setVal('verificationId', v.id);

                    // вытаскиваем флаг из начала имени
                    const { flag, name } = extractFlagFromName(v.drop_name || '');
                    setVal('dropName', name || '');
                    setVal('dropFlag', flag || '');

                    setVal('siteUrl', v.site_url || '');
                    setVal('registryUrl', v.registry_url || '');
                    setVal('verificationStatus', v.status || 'todo');
                    setVal('verificationNotes', v.notes || '');
                    (v.banks || []).forEach(b => {
                        const bankId = b.bank_id || bankIdByNameLoose(b.name);
                        addBankInput(b.name, normalizeBankStatus(b.status), normalizeWorkerId(b.worker), bankId);
                    });
                    (v.images || []).forEach(src => addImagePreview(src));
                } else {
                    $('#verificationModalTitle').textContent = 'Добавить заявку на верификацию';
                    setVal('verificationId', '');
                    setVal('dropName', '');
                    setVal('dropFlag', ''); // новый инпут — очищаем
                    setVal('verificationStatus', 'todo');
                    addBankInput();
                }
                showModal(verificationModal); setTimeout(() => $('#dropName').focus(), 0);
            }
            function closeVerificationModal() { hideModal(verificationModal); }

            function openPayoutModal(p = null) {
                payoutForm.reset();
                if (p) {
                    $('#payoutModalTitle').textContent = 'Редактировать выплату';
                    setVal('payoutId', p.id);
                    setVal('payoutWorker', normalizeWorkerId(p.worker_id) || 'sanya');
                    setVal('payoutAmount', p.amount ?? '');
                    setVal('payoutReason', p.reason || '');
                    setVal('payoutDate', (p.date || '').slice(0, 10));
                    setVal('payoutCurrency', (p.currency || 'RUB'));
                } else {
                    $('#payoutModalTitle').textContent = 'Добавить выплату';
                    setVal('payoutId', '');
                    setVal('payoutWorker', 'sanya');
                    setVal('payoutAmount', '');
                    setVal('payoutReason', '');
                    setVal('payoutDate', new Date().toISOString().slice(0, 10));
                    setVal('payoutCurrency', 'RUB');
                }
                showModal(payoutModal);
                setTimeout(() => $('#payoutAmount').focus(), 0);
            }

            function closePayoutModal() { hideModal(payoutModal); }

            async function handlePayoutFormSubmit(e) {
                e.preventDefault();
                const id = val('payoutId');
                const payload = {
                    id: id || uid(),
                    worker_id: normalizeWorkerId(val('payoutWorker')) || 'sanya',
                    amount: Number(val('payoutAmount')),
                    currency: (val('payoutCurrency') || 'RUB').toUpperCase(),
                    reason: val('payoutReason').trim(),
                    date: val('payoutDate'),
                    created_at: id ? (payouts.find(x => x.id === id)?.created_at || new Date().toISOString()) : new Date().toISOString()
                };

                if (!isFinite(payload.amount)) { alert('Введите корректную сумму'); return; }
                if (!payload.reason) { alert('Заполните поле «За что выплатил»'); return; }
                if (!payload.date) { alert('Укажите дату'); return; }

                // оптимистическое обновление
                const i = payouts.findIndex(x => x.id === payload.id);
                if (i > -1) payouts[i] = payload; else payouts.push(payload);
                render();

                await savePayout(payload);
                closePayoutModal();
            }


            function addBankInput(bankName = '', bankStatus = 'open', bankWorker = '', bankId = '') {
                const statusNorm = normalizeBankStatus(bankStatus);
                const workerNorm = normalizeWorkerId(bankWorker);

                // пытаемся понять id банка из переданного имени/ид
                const resolvedBankId = bankId || bankIdByNameLoose(bankName) || '';

                const row = div('bank-input-row');
                row.innerHTML = `
    <select class="form-control bank-name" title="Банк">
      <option value="">— Банк —</option>
      ${BANKS.map(b => `<option value="${b.id}" ${b.id === resolvedBankId ? 'selected' : ''}>${b.name}</option>`).join('')}
    </select>
    <select class="form-control bank-status" title="Статус">
      ${bankStatuses.map(s => `<option value="${s.id}" ${s.id === statusNorm ? 'selected' : ''}>${s.name}</option>`).join('')}
    </select>
    <select class="form-control bank-worker" title="Ответственный">
      <option value="">— Воркер —</option>
      ${bankWorkers.map(w => `<option value="${w.id}" ${w.id === workerNorm ? 'selected' : ''}>${w.name}</option>`).join('')}
      ${workerNorm && !bankWorkers.find(w => w.id === workerNorm)
                        ? `<option value="${workerNorm}" selected>(${workerLabel(workerNorm)})</option>` : ''}
    </select>
    <button type="button" class="remove-bank" title="Удалить банк"><i class="fas fa-times"></i></button>`;
                row.querySelector('.remove-bank').addEventListener('click', () => row.remove());
                bankInputs.appendChild(row);
            }

            /* Images: compress + upload to Storage */
            function onImagesChosen(e) { handleImageFiles(Array.from(e.target.files || [])); e.target.value = ''; }

            async function handleImageFiles(files) {
                const existing = $all('.uploaded-image img', uploadedImages).length;
                const left = Math.max(0, 6 - existing);
                const pick = files.slice(0, left);
                if (files.length > left) alert('Можно прикрепить максимум 6 фото к заявке.');

                for (const f of pick) {
                    if (!f.type.startsWith('image/')) continue;
                    const blob = await compressFile(f, 1200, 0.75);
                    const fileName = `${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
                    const path = `uploads/${fileName}`;
                    const { error: upErr } = await supabase.storage.from(STORAGE_BUCKET).upload(
                        path,
                        blob,
                        { contentType: 'image/jpeg', upsert: true, cacheControl: '3600' });
                    if (upErr) { console.error(upErr); alert('Не удалось загрузить изображение'); continue; }
                    const { data } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
                    const url = data.publicUrl;
                    addImagePreview(url);
                }
            }

            function addImagePreview(dataUrl) {
                const box = div('uploaded-image');
                box.innerHTML = `<img src="${dataUrl}" alt="Uploaded"><button type="button" class="remove-image" title="Удалить"><i class="fas fa-times"></i></button>`;
                box.querySelector('img').addEventListener('click', () => showLightbox(dataUrl));
                box.querySelector('.remove-image').addEventListener('click', () => box.remove());
                uploadedImages.appendChild(box);
            }

            async function compressFile(file, maxW = 1200, quality = 0.75) {
                const src = await fileToDataURL(file);
                const img = await loadImg(src);
                const scale = Math.min(1, maxW / img.width);
                const w = Math.round(img.width * scale), h = Math.round(img.height * scale);
                const c = document.createElement('canvas'); c.width = w; c.height = h;
                const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
                const blob = await new Promise(res => c.toBlob(res, 'image/jpeg', quality));
                if (blob) return blob;
                // Фолбэк: если toBlob вернул null — берём исходный файл
                return file;
            }

            /* Submit verification */
            async function handleVerificationFormSubmit(e) {
                e.preventDefault();
                const id = val('verificationId');
                const rawName = val('dropName').trim();
                const rawFlag = val('dropFlag').trim();
                const flag = normalizeFlagInput(rawFlag);
                const extracted = extractFlagFromName(rawName);
                const cleanName = extracted.name || rawName;
                const finalDropName = (flag ? (flag + ' ') : '') + cleanName;

                const banks = [];
                $all('.bank-input-row', bankInputs).forEach(r => {
                    const bankId = $('.bank-name', r).value.trim();     // <-- теперь из select
                    const status = normalizeBankStatus($('.bank-status', r).value);
                    const worker = normalizeWorkerId($('.bank-worker', r).value);
                    if (bankId) {
                        banks.push({
                            bank_id: bankId,               // стабильный идентификатор
                            name: bankLabelById(bankId),   // читаемая метка для карточки/поиска
                            status,
                            worker
                        });
                    }
                });

                const images = $all('.uploaded-image img', uploadedImages).map(img => img.src);

                const payload = {
                    id: id || uid(),
                    drop_name: finalDropName,
                    site_url: val('siteUrl').trim(),
                    registry_url: val('registryUrl').trim(),
                    banks,
                    status: val('verificationStatus') || 'todo',
                    images,
                    notes: val('verificationNotes').trim(),
                    created_at: id ? (verificationRequests.find(v => v.id === id)?.created_at || new Date().toISOString()) : new Date().toISOString()
                };

                if (!payload.drop_name || !payload.site_url) { alert('Заполните имя дропа и ссылку на сайт'); return; }
                if (!payload.banks.length) { alert('Добавьте хотя бы один банк'); return; }

                const i = verificationRequests.findIndex(x => x.id === payload.id);
                if (i > -1) verificationRequests[i] = payload; else verificationRequests.push(payload);
                render();

                await saveVerification(payload);
                closeVerificationModal();
            }

            /* Export / Import with DB upsert */
            function importProjects(e) {
                importJSONFile(e, async data => {
                    if (!Array.isArray(data)) { alert('Файл должен содержать массив проектов'); return; }
                    for (const p of data) {
                        const mapped = {
                            id: p.id || uid(),
                            name: p.name || '',
                            site_url: p.site_url || p.siteUrl || '',
                            registry_url: p.registry_url || p.registryUrl || '',
                            description: p.description || '',
                            status: p.status || 'todo',
                            tags: Array.isArray(p.tags) ? p.tags : [],
                            due_date: p.due_date || p.dueDate || null,
                            created_at: p.created_at || p.createdAt || new Date().toISOString()
                        };
                        await saveProject(mapped);
                    }
                    await load(); render();
                });
            }
            function importVerification(e) {
                importJSONFile(e, async data => {
                    if (!Array.isArray(data)) { alert('Файл должен содержать массив заявок'); return; }
                    for (const v of data) {
                        const mapped = {
                            id: v.id || uid(),
                            drop_name: v.drop_name || v.dropName || '',
                            site_url: v.site_url || v.siteUrl || '',
                            registry_url: v.registry_url || v.registryUrl || '',
                            banks: Array.isArray(v.banks) ? v.banks : [],
                            status: v.status || 'todo',
                            images: Array.isArray(v.images) ? v.images : [],
                            notes: v.notes || '',
                            created_at: v.created_at || v.createdAt || new Date().toISOString()
                        };
                        await saveVerification(mapped);
                    }
                    await load(); render();
                });
            }
            function importPayouts(e) {
                importJSONFile(e, async data => {
                    if (!Array.isArray(data)) { alert('Файл должен содержать массив выплат'); return; }
                    for (const p of data) {
                        const mapped = {
                            id: p.id || uid(),
                            worker_id: normalizeWorkerId(p.worker_id || p.worker) || 'sanya',
                            amount: Number(p.amount || 0),
                            currency: (p.currency || 'RUB').toUpperCase(),
                            reason: p.reason || '',
                            date: p.date || (p.created_at ? p.created_at.slice(0, 10) : new Date().toISOString().slice(0, 10)),
                            created_at: p.created_at || new Date().toISOString()
                        };
                        await savePayout(mapped);
                    }
                    await load(); render();
                });
            }


            /* Helpers */
            function $(s, r = document) { return r.querySelector(s); }
            function $all(s, r = document) { return Array.from(r.querySelectorAll(s)); }
            function div(c, html) { const d = document.createElement('div'); if (c) d.className = c; if (html != null) d.innerHTML = html; return d; }
            function uid() { return Math.random().toString(36).slice(2, 10); }
            function esc(s) { return (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }
            function linkMasked(u, label) {
                if (!u) return '';
                const safe = esc(u);
                return `<a href="${safe}" target="_blank" rel="noopener noreferrer" class="verification-link" title="${safe}">${esc(label)}</a>`;
            }
            function nullIfEmpty(v) { return (v == null || String(v).trim() === '') ? null : v; }
            function setVal(id, v) { $('#' + id).value = v; }
            function val(id) { return $('#' + id).value; }
            function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }
            function showModal(m) { m.style.display = 'flex'; m.setAttribute('aria-hidden', 'false'); }
            function hideModal(m) { m.style.display = 'none'; m.setAttribute('aria-hidden', 'true'); }
            function downloadJSON(obj, name) { const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href); }
            function importJSONFile(e, cb) { const f = e.target.files[0]; if (!f) return; const fr = new FileReader(); fr.onload = () => { try { const data = JSON.parse(fr.result); cb(data); } catch (err) { alert('Ошибка чтения JSON'); } e.target.value = ''; }; fr.readAsText(f); }
            function fileToDataURL(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }
            function loadImg(src) { return new Promise((res, rej) => { const i = new Image(); i.onload = () => res(i); i.onerror = rej; i.src = src; }); }
            function showLightbox(src) { const img = lightbox.querySelector('img'); img.src = src; lightbox.style.display = 'flex'; }
            function normalizeBankStatus(s) {
                if (!s) return 'open';
                // соответствия старых id → новым id
                if (s === 'verification') return 'need_verify'; // старый «На верифе»
                // можно расширять при необходимости:
                // if (s === 'something_old') return 'something_new';
                return s;
            }

            // Превращаем "RU" -> "🇷🇺"; если пришло эмоджи-флаг — вернём как есть; иначе ''.
            function normalizeFlagInput(s) {
                if (!s) return '';
                s = s.trim();
                if (isFlagEmoji(s)) return s;
                const m = s.match(/^[A-Za-z]{2}$/);
                if (m) return countryCodeToFlag(s);
                return '';
            }

            function countryCodeToFlag(cc) {
                cc = cc.trim().toUpperCase();
                if (!/^[A-Z]{2}$/.test(cc)) return '';
                const A = 0x1F1E6; // 'A' региональный индикатор
                return String.fromCodePoint(A + (cc.charCodeAt(0) - 65), A + (cc.charCodeAt(1) - 65));
            }

            function isFlagEmoji(s) {
                // Эмоджи-флаг — это две "Regional Indicator Symbols" подряд
                if (!s) return false;
                const cp = Array.from(s);
                if (cp.length < 2) return false;
                const c0 = cp[0].codePointAt(0), c1 = cp[1].codePointAt(0);
                return c0 >= 0x1F1E6 && c0 <= 0x1F1FF && c1 >= 0x1F1E6 && c1 <= 0x1F1FF;
            }

            // Достаём флаг из начала строки и возвращаем { flag, name }
            function extractFlagFromName(full) {
                if (!full) return { flag: '', name: '' };
                const trimmed = full.trim();
                // Если начинается с флага (две региональные буквы)
                const firstTwo = Array.from(trimmed).slice(0, 2).join('');
                if (isFlagEmoji(firstTwo)) {
                    return { flag: firstTwo, name: trimmed.slice(firstTwo.length).trimStart() };
                }
                return { flag: '', name: trimmed };
            }

            // bootstrap
            await load();
            render();
            startRealtime();
        })();
    </script>
</body>

</html>
